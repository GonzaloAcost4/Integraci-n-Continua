name: CI/CD + Deploy a Vercel

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read
  id-token: write

jobs:
  build:
    name: üîß Build + Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Instalar dependencias
        run: npm ci

      - name: Ejecutar build del proyecto
        run: npm run build

      - name: Ejecutar tests con cobertura
        run: npm run test

      - name: Notificar por Slack si falla build
        if: failure()
        uses: slackapi/slack-github-action@v2.1.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            text: |
              ‚ùå *Build fall√≥* en `${{ github.workflow }}`.
              Autor: <${{ github.event.sender.html_url }}|${{ github.actor }}>
              Commit: <${{ github.event.head_commit.url }}|${{ github.sha }}>
            ‚Ä¢ üîó <https://integraci-n-continua-rlf8y9fz5-gonzaloacost4s-projects.vercel.app/|Ver sitio en producci√≥n>

  sonarcloud:
    name: üîç An√°lisis SonarCloud
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Instalar dependencias
        run: npm ci

      - name: Ejecutar an√°lisis SonarCloud
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Notificar por Slack si falla SonarCloud
        if: failure()
        uses: slackapi/slack-github-action@v2.1.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            text: |
              ‚ö†Ô∏è *SonarCloud report√≥ errores* en `${{ github.workflow }}`.
              Autor: <${{ github.event.sender.html_url }}|${{ github.actor }}>
              Commit: <${{ github.event.head_commit.url }}|${{ github.sha }}>
            ‚Ä¢ üîó <https://integraci-n-continua-rlf8y9fz5-gonzaloacost4s-projects.vercel.app/|Ver sitio en producci√≥n>


  deploy:
    name: üöÄ Deploy a Vercel
    needs: sonarcloud
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Instalar dependencias
        run: npm ci

      - name: Build de producci√≥n con Vite
        run: npm run build

      - name: Instalar Vercel CLI
        run: npm install --global vercel

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project Artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy Project Artifacts
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Notificar resultado de Deploy en Slack
        if: always()
        uses: slackapi/slack-github-action@v2.1.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            text: |
              üöÄ *Deploy terminado* en `${{ github.workflow }}`
              Estado: `${{ job.status }}`
              Autor: <${{ github.event.sender.html_url }}|${{ github.actor }}>
              Commit: <${{ github.event.head_commit.url }}|${{ github.sha }}>

            ‚Ä¢ üîó <https://integraci-n-continua-rlf8y9fz5-gonzaloacost4s-projects.vercel.app/|Ver sitio en producci√≥n>
